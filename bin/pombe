#!/usr/bin/env sh

set -euo pipefail
IFS=$'\n\t'

fetch() {
  echo 1>&2 "Fetching $1"
  curl "$1" 2>/dev/null | gzip -d
}

base="$PWD/data/pombe/"
remote_genome="ftp://ftp.ensemblgenomes.org/pub/current/fungi/fasta/schizosaccharomyces_pombe/dna/Schizosaccharomyces_pombe.ASM294v2.dna.toplevel.fa.gz"
extra_genome="ftp://ftp.ebi.ac.uk/pub/databases/pombase/pombe/Chromosome_Dumps/fasta/Schizosaccharomyces_pombe.ASM294v2.30.dna.genome.fa.gz"
remote_known="ftp://ftp.ebi.ac.uk/pub/databases/RNAcentral/releases/6.0/genome_coordinates/Schizosaccharomyces_pombe.ASM294v2.gff3.gz"
remote_bed="ftp://ftp.ebi.ac.uk/pub/databases/RNAcentral/releases/6.0/genome_coordinates/Schizosaccharomyces_pombe.ASM294v2.bed.gz"
remote_md5s='ftp://ftp.ebi.ac.uk/pub/databases/RNAcentral//releases/6.0/md5/md5.tsv.gz'
matcher="exact"

known="$(basename "$remote_known" '.gz')"
genome="$(basename "$remote_genome" '.gz')"
extra="$(basename "$extra_genome" '.gz')"
bed="$(basename "$remote_bed" '.gz')"
md5s="$(basename "$remote_md5s" '.gz')"
targets="has-coordinates.fasta"

sums="$base/md5sums.txt"
initial="$base/initial-hits.pickle"
selected="$base/selected-hits.pickle"
compared="$base/compared.pickle"
gff="$base/compared.gff3"
summary="$base/summary.csv"

tmp="$(mktemp -d)"
pushd "$tmp"

cat >bad-silva <<EOF
URS000055C986
URS00002B25BC
URS000017889A
URS00001C5837
EOF

echo 1>&2 'Fetching remote data'

cat 1>&2 <<EOF
This is excluding extracting and hasing from silva that have known issues.
Notably the sequences from silva are too short, often. This leads to the ranges
in the bed file being wrong. And since the range is wrong the extracted
sequences and then hashes are wrong. Excluding:
EOF
cat bad-silva

fetch "$remote_bed" | correct-bed.py - - | grep -vf bad-silva > $bed
fetch "$remote_known" > "$known"
fetch "$remote_genome" > "$genome"
fetch "$extra_genome" > "$extra"
fetch "$remote_md5s" > "$md5s"

echo 1>&2 'Extracting targets'
bedtools getfasta -split -name -s -fi "$genome" -bed "$bed" | sed 's/::/ /' > "$targets"

# echo 1>&2 'Checking MD5 sums'
# md5sum -c "$sums"

echo 1>&2 'Validating sequence hashes'
fasta.py md5 display $targets computed.tsv
xsv join --no-headers -d '\t' 1 computed.tsv 1 $md5s | cut -d ',' -f1,2,4 > compared-md5.csv
awk -F ',' '{ if ($2 != $3) print "Sequence", $1, "extracted incorrectly"; }' compared-md5.csv > bad-md5
cat bad-md5

[ -s bad-md5 ] && exit 1
echo 1>&2 'All hashes pass'

echo 'Manually adding the excluded sequences back to the target file'
cat >>"$targets" <<EOF
>URS00001C5837 MT:3,147-4,523:1
ATAAAAATATATATAATGAGTTTGATGTTAGCTCGGTTATAACGCTATCTAGAGATTTTAACACATGCAAATCGAACGAATCAACAAAAACAATACATCCTTTAGGGGATGTTTGTGTTTTTTTGTGACGTGGTGAACAGGTGAGTAAAAGGGAAGAACGGACCTTAAATTTCGGCTAAATTCCGAATAAACACACTCTTTTGGAGTGTTGTGAAAGAAGTGAAAACTTTGATTTAAGACTGGCTTCTTACGATTAAAGTAGTTGGAGAGGTAAAAGCTTAACAAGCTCAAATCGTAATCATGACACTAAGTGGTGCTCTGATCACATTGGCTCTGAGACAACAGCCAAGATGAACATTTAGTTCATCCAGCAGTGGAGAATATTAGTCAATGATCGAAAGATTGAACTAGTCATCTAGAAGAGTGAAACTTTTAGTTATAGCTCCTTAAATTAAGAAAATTTGATTCTTAATTTTATGTAATTCTTGCCAATTTCCGTGCCAGCAGCAGCGGTTATACGGATAGAATAAGCGTTTAACATAATAAAAAGGCCTAAAAAGTATGTAGATGGAAAAAAACAAATCTTTTTCTAGAGTAATAAAGATGTTTGTAGTATTGTCAAATAAGGGATCAAATCCGACAATCTTGATGAGACTGCTTAAGTAAAAACTACTTACAATTAATTACTGACATTGAGATACGAAGGCTTAGATCGCGAAAGAGATTAGATACCTCTGTAGTCTAAGCTGTAAACGATTATTGCTCTCCCAATCTTTTTGATTGGGTTTAGTGAAGACGGTAAGCAATATGCCTGGGGAGTACTTTCGCAAGATTGAAACCCAAAACATTAGACGGTCTTGGAAATCCGCAGTGAATCATGTTATTTAATTAGATAATCCGCTAAAAATCTTACCTTTCCTTAAAACAATTAGTTTTAATTGTTGGGTATTGCATGGCTGTCTTTAGTTAATCTCGTAAGATGAGGTTAATTCCCATTAATTAACGAAAGCCTTCAAAGAATTTGTTTTTCTTTGTGTTAGTGATAAGCTAACTTTTTAGAGGGTTAAGACAAGTCAATATGATCCTTATGGAAAGGGCTATAGACGTGATATAAAATCTAATCCAATAATTTTTAATATCGAAAGATTGAAGTATTATTATAATGGTTAGGAGATTTATTCAGATTTAAATCTGTAATTTGATTTAATGAAGGAGGAATTGCGAGTAATCACTAATCATTACGTAGTGGTGAAATTTATCTCTGAGATGTACTAACTACTCGTCAAGCGCTGAAAGTATTAATCTCTTGAAGAAGACATTCATTTGTTTTCCCAAGGTGTTGTGCAATTAGTGTTAAGTCGAAATAAGGTAACCGTAGTGGAAGTTGCGGTTGAACTAATTAATTCAGGTTAACCCCCCCCC
>URS00002B25BC III:2,451,883-2,452,883:1
TACCTGGTTGATCCTGCCAGTAGTCATATGCTTGTCTCAAAGATTAAGCCATGCATGTCTAAGTATAAGCAATTTTGTACTGTGAAACTGCGAATGGCTCATTAAATCAGTTATCGTTTATTTGATAGTACCTCAACTACTTGGATAACCGTGGTAATTCTAGAGCTAATACATGCTAAAAATCCCGACTTTTTTGGAAGGGATGTATTTATTAGATAAAAAACCAATGCCTTCGGGCTTTTTTTGGTGAGTCATAATAACTTTTCGAATCGCATGGCCTTGCGCCGGCGATGGTTCATTCAAATTTCTGCCCTATCAACTTTCGATGGTAGGATAGAGGCCTACCATGGTTTTAACGGGTAACGGGGAATTAGGGTTCGATTCCGGAGAGGGAGCCTGAGAAACGGCTACCACATCCAAGGAAGGCAGCAGGCGCGCAAATTACCCAATCCCGACACGGGGAGGTAGTGACAAGAAATAACAATGCAGGGCCCTTTCGGGTCTTGTAATTGGAATGAGTACAATGTAAATACCTTAACGAGGAACAATTGGAGGGCAAGTCTGGTGCCAGCAGCCGCGGTAATTCCAGCTCCAATAGCGTATATTAAAGTTGTTGCAGTTAAAAAGCTCGTAGTTGAACTTTGAGCCTGGTCGACTGGTCCGCCGCAAGGCGTGTTTACTGGTCATGACCGGGGTCGTTAACCTTCTGGCAAACTACTCATGTTCTTTATTGAGCGTGGTAGGGAACCAGGACTTTTACCTTGAAAAAATTAGAGTGTTCAAAGCAGGCAAGTTTTGCTCGAATACATTAGCATGGAATAATAAAATAGGACGTGTGGTTCTATTTTGTTGGTTTCTAGGACCGCCGTAATGATTAATAGGGATAGTCGGGGGCATTCGTATTCAATTGTCAGAGGTGAAATTCTTGGATTTATTGAAGACGAACTACTGCGAAAGCATTTGCCAAGGATGTTTTCATTAATCAAGAACGAAAGTTAGGG
> URS000055C986
TACCTGGTTGATCCTGCCAGTAGTCATATGCTTGTCTCAAAGATTAAGCCATGCATGTCTAAGTATAAGCAATTTTGTACTGTGAAACTGCGAATGGCTCATTAAATCAGTTATCGTTTATTTGATAGTACCTCAACTACTTGGATAACCGTGGTAATTCTAGAGCTAATACATGCTAAAAATCCCGACTTTTTTGGAAGGGATGTATTTATTAGATAAAAAACCAATGCCTTCGGGCTTTTTTTGGTGAGTCATAATAACTTTTCGAATCGCATGGCCTTGCGCCGGCGATGGTTCATTCAAATTTCTGCCCTATCAACTTTCGATGGTAGGATAGAGGCCTACCATGGTTTTAACGGGTAACGGGGAATTAGGGTTCGATTCCGGAGAGGGAGCCTGAGAAACGGCTACCACATCCAAGGAAGGCAGCAGGCGCGCAAATTACCCAATCCCGACACGGGGAGGTAGTGACAAGAAATAACAATGCAGGGCCCTTTCGGGTCTTGTAATTGGAATGAGTACAATGTAAATACCTTAACGAGGAACAATTGGAGGGCAAGTCTGGTGCCAGCAGCCGCGGTAATTCCAGCTCCAATAGCGTATATTAAAGTTGTTGCAGTTAAAAAGCTCGTAGTTGAACTTTGAGCCTGGTCGACTGGTCCGCCGCAAGGCGTGTTTACTGGTCATGACCGGGGTCGTTAACCTTCTGGCAAACTACTCATGTTCTTTATTGAGCGTGGTAGGGAACCAGGACTTTTACCTTGAAAAAATTAGAGTGTTCAAAGCAGGCAAGTTTTGCTCGAATACATTAGCATGGAATAATAAAATAGGACGTGTGGTTCTATTTTGTTGGTTTCTAGGACCGCCGTAATGATTAATAGGGATAGTCGGGGGCATTCGTATTCAATTGTCAGAGGTGAAATTCTTGGATTTATTGAAGACGAACTACTGCGAAAGCATTTGCCAAGGATGTTTTCATTAATCAAGAACGAAAGTTAGGGGATCGAAGACGATCAGATACCGTCGTAGTCTTAACCATAAACTATGCCGACTAGGGATCGGGCAATGTTTCATTTATCGACTTGCTCGGCACCTTACGAGAAATCAAAGTCTTTGGGTTCCGGGGGGAGTATGGTCGCAAGGCTGAAACTTAAAGGAATTGACGGAAGGGCACCACAATGGAGTGGAGCCTGCGGCTTAATTTGACTCAACACGGGGAAACTCACCAGGTCCAGACATAGTAAGGATTGACAGATTGAGAGCTCTTTCTTGATTCTATGGGTGGTGGTGCATGGCCGTTCTTAGTTGGTGGAGTGATTTGTCTGCTTAATTGCGATAACGAACGAGACCTTAACCTGCTAAATAGCTGGATCAGCCATTTTGGCTGATCATTAGCTTCTTAGAGGGACTATTGGCATAAAGCCAATGGAAGTTTGAGGCAATAACAGGTCTGTGATGCCCTTAGATGTTCTGGGCCGCACGCGCGCTACACTGACGGAGCCAACGAGTTGAAAAAAATCTTTTGATTTTTTATCCTTGGCCGGAAGGTCTGGGTAATCTTGTTAAACTCCGTCGTGCTGGGGATAGAGCATTGCAATTATTGCTCTTCAACGAGGAATTCCTAGTAAGCGCAAGTCATCAGCTTGCGTTGAATACGTCCCTGCCCTTTGTACACACCGCCCGTCGCTACTACCGATTGAATGGCTTAGTGAGGCCTCTGGATTGGCTTGTTTCTGCTGGCAACGGCGGAAACATTGCCGAGAAGTTGGACAAACTTGGTCATTTAGAGGAAGTAAAAGTCGTAACAAGGTTTCCGTAGGTGAACCTGCGGAAGGATCATTA
>URS000017889A MT:34-2,760:1
AATGTGTAATTTGAATCAATTTCTATCCTTTTAAAAATACATCATAAAGTGTACTTTTTTAAGGATTTAGTTATTAAAGGATTAATTATGGATTGCTAACCAGTTAATATTAAGAGGAAGCTTTTAAAGCTTAATTCAGCAATTTTTTAATTGTTGTTTCTCCTAAAGGTAAACCACTAAAAAGAAAGAACTTCGGGTTTTTCTTTAAAATAAACTAGAGGAACTGAATCATCTTAGTACTCTAAGGAAAATAAAATAACAATGATTATTGTAGTAGTGGCGAACGAATCATTAATAGTCTAACTTATAAAAATATTAAAAAAAATTTTTACCAAAGAAGAGAAAAATGGGTTCTTCATTTTTAATAAGTAATAAGTAATAAAGTAAAATGGGAACTTAACCTGTTTGAATATTGGAGAACCAATCTCCAAAGACTAAATATATTAACTGAGTGATAGTGAAGAGTACCGTAAGGGAAAGCAATGAAATAGTTAATCTATAAGCGAAGATAGTGAATTTTAAATAAATTATTATCTTGTACCTTTTGCATAATGGGTCAGCAAGTTTTAATTATTTGCAAGCTGAAAAGCCATAAAGTAAATAATTAAAGACCCGAAACCTGACGATCTTACCATGAACAGATTTTAAGGATCGAACCAGTAATCGTTGCAAAGATTTTGGATGATTTGTGGTAAGGGGTGAAATGCTAATCGAGTTAGGTGATAGCTGGTTGTCCACGAAACCATTTTAAGATGGGCACTTCAAAAACTAAATGAGGTACAGAAATTTATTGCCTTCAAGAAGTTTTTTCTTGTTAATAGGGGATCTAAAGATTTACCTAAGGCGTTAATTAATCTCGGAATAAATTTAAAAAAGTTTGAAGTAGTTAGACAATTGGCGATAAGGTCAATAGTCAAAAGAGAAACAGCTCAGATCAAAGATTTAAAGTTCCCCAATTTAAGTTAAGTGATTTAAAGATAGTCTTACTCCTTATTCAATAAGAATATGGGCTTGGAAACAGCCATTATCTAAGGAGTACGTAATAGTTCACTTATCCAAAAAAAATAATATTTTCTGGAGAAAGGCATCAAAAATTTAACGGATCTTAAACTTAATACTTAAACTTTGGCAGTATTTTAAAAATACTGGGTAGTGGACCGATCTATATAAAGATGAAGATGAACTTTTAAGTTTATTGGATTTATTAGATGCGAGAATGCTGACATAAGTAACGTAAAAAAAGGTCAAATTCCTTTTCACCGAAAACTGAAGGGTTTTGACTTAAAAAGCTTAGCTTAAGTCAAATAAAGTAACAATCTCTAAGCTAATAAATAGTGATGAGTAAATCTTAACGGATCTTAAAATAAAAGTTTTATTGAATAGAAATTTTTATTCAGGAAAATTATCCGTTATTTTAATTGTACCCTAAACCGACACTGGTCAGTTAAGAGAATATCTTAAGGTGTTGAGAGAACTATGCTTAAGGAACTCGGCAAATTAGCTCTGTTACTTCGGTATAAAGAGTGTTCATTATTTTATGAACTCAATAAAGAGAACCCTACAACTGTTTACTTAAAACACAGCACATTGCCAAAATTAAAAAATTATAGTATAATGTGTGAGGTCTGCTCAATGTCCTATGGTTAACAATACGAACTTTAACGAGTTTTACGGAACCCAGGATAAATAGCGGCTTTAACTCTGAGGGTCCTAAGGTAGCGAAATTCCTTGTCCGATAAATACGGTCCCGCATGAATGACTTAATGATAGGGTTGCTGTCTCAAGCACAGACTCAGTGAAATTGTAATTGCTGTGAAGATACAGTGTTCCCTCAGCTAGACGGAAAGACCCTGGCAGCTTTACGATAGTTAATTATTGATTAAAGAAAAAATCATCCAAAAGGTGATCTCTTCTTTCTCGCTTTATCTATTTTTGTTCAGTATAGAGGTTAGTCGTTTAGACAAAAATGAGATATCCTCCTTAAATAATAAAGATCTTTAAAGTTTAAACTTGACATTAATTAATTGATCGTTTCTGTGGGGCGCAGGCCTCATAAAAAATAACTGAGGTATCCTAGATCTATATAATTTATCTAGAAATCAAAGTATCCAGAAACATTTTTTAAGTGTTTCTTAATTAAAGATACATGACGCATATAAGCATAAATAGGTTAAACTGAAAGACTAACAAGTCGCACAGATATGTAAATAGGGTTAAATGATCCACATTGAAACACTAATTTAGTGTTTGTATGGAAAACAATGTGCTCAATGAGCGAAGTTACGCCAGGGATAACAGGTTAATAGAGAGCTAAAGTACAAATCAAATTCTCTGTTTGACACCTCGATGTCGACTCAACCTATCTCCGGTTGTAGCAGATTGGAAGGGTTAGACTGTTCGTCTATTTAAAAGGTTACGTGAGTTGGGTTAAATCCGTCGTAAGACAGGATGGTTCCTATCTACTGAGGGAAAAATAAGCAAATTAAAATTTATCTTTTGTACGCAAGGATTTAGATAATTCAATCTCTAGTTTAACTATTGTTACTTAAATAAAAGTACTTTATTCAAAAGTTAAAAATTAAGTAGCACGGTAGTAAAGCCAAATTGAACAAATTAAAAACTGAAAGCATCTCAAGTTTGAAATTTATTTAAAGAGCTTATATTAAGAAAGTAGAAAACTTTCCAAAAGGACATCCTTAGGATGTACAAATCCTTATTTTAGTAAATCATTGTTTAGATAGATTTAGTTAATTTTTTAACCAAAGGGATTATCTCTTTGCTAATTTTTTAAATAACTGGAAATTGCCTAATTACACAATTTT
EOF

echo 'Altering targets to RNA'
fasta.py dna-to-rna "$targets" t
mv t "$targets"

cp "$bed" "$known" "$genome" "$targets" "$base"
popd
rm -r "$tmp"

known="$base/$known"
genome="$base/$genome"
bed="$base/$bed"
targets="$base/$targets"

echo 1>&2 'Searching for targets'
gm.py find "$genome" "$targets" "$initial"

echo 1>&2 'Selecting matching hits'
gm.py hits select "$initial" "$matcher" "$selected"

echo 1>&2 'Comparing to known locations'
gm.py hits compare "$selected" "$known" "$compared"

echo 1>&2 'Writing gff file from comparisions'
gm.py as "$compared" gff "$gff"

gm.py comparisions summary "$compared" - | tee "$summary" | xsv table
